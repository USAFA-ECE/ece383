

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>🔬 Lab 3 Software Control of a Datapath &#8212; Embedded Systems II</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script src="../_static/tabs.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Assignments/lab3';</script>
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="🔬 ICE 1: Intro to Microblaze" href="ice1.html" />
    <link rel="prev" title="🔬 Lab 2: Data Acquisition, Storage and Display" href="lab2.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/ece383.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/ece383.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    ECE383 Embedded Computer Systems II
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Course Info</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../syllabus.html">🚩 Syllabus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../schedule.html">📆 Course Schedule</a></li>
<li class="toctree-l1"><a class="reference internal" href="../vhdl_programming.html">💻 VHDL Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../c_programming.html">💻 C Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">🙋 FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../resources.html">💎 Resources</a></li>

<li class="toctree-l1"><a class="reference internal" href="../debugging.html">🪲 Debugging</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Homeworks</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="homework1.html">✏️ HW 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework2.html">✏️ HW 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework3.html">✏️ HW 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework4.html">✏️ HW 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework5.html">✏️ HW 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework7.html">✏️ HW 7</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework8.html">✏️ HW 8</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework8b.html">✏️ HW 8b</a></li>
<li class="toctree-l1"><a class="reference internal" href="homework9.html">✏️ HW 9</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Labs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="lab1.html">🔬 Lab 1: VGA Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="lab2.html">🔬 Lab 2: Data Acquisition, Storage and Display</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">🔬 Lab 3 Software Control of a Datapath</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ICEs</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="ice1.html">🔬 ICE 1: Intro to Microblaze</a></li>
<li class="toctree-l1"><a class="reference internal" href="ice2.html">🔬 ICE 2: Microblaze Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="ice3.html">🔬 ICE 3: Microblaze Interrupts</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/USAFA-ECE/ece383" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/USAFA-ECE/ece383/issues/new?title=Issue%20on%20page%20%2FAssignments/lab3.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/Assignments/lab3.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>🔬 Lab 3 Software Control of a Datapath</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">📌 Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">📜 Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure">💻 Procedure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware">Hardware</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-setup">Hardware Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-and-testing">Implementation and Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned-the-hard-way-in-previous-years">Lessons Learned the Hard Way in Previous Years</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deliverables">🚚 Deliverables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-1-design">Gate Check 1 - Design</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-2-lab-2-with-exsel-off-0">Gate Check 2 - Lab 2 with ExSel Off (‘0’)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-3-cpu-interface">Gate Check 3 - CPU Interface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#required-functionality">Required Functionality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-level-functionality">A-level Functionality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#turn-in">Turn In</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#readme">README</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grading">Grading</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="lab-3-software-control-of-a-datapath">
<h1>🔬 Lab 3 Software Control of a Datapath<a class="headerlink" href="#lab-3-software-control-of-a-datapath" title="Permalink to this heading">#</a></h1>
<section id="objectives">
<h2>📌 Objectives<a class="headerlink" href="#objectives" title="Permalink to this heading">#</a></h2>
<ul class="simple">
<li><p>Students should implement a soft CPU in the fabric of the FPGA and use it to control a hardware datapath</p></li>
</ul>
</section>
<section id="synopsis">
<h2>📜 Synopsis<a class="headerlink" href="#synopsis" title="Permalink to this heading">#</a></h2>
<p>In this lab, we will integrate the video display controller developed in Lab 2 with the MicroBlaze processor built using the fabric of the Artix-7 FPGA. In the preceding lectures, we learned about the Vivado and SDK tool chains, now it’s time to put that knowledge to the test by building a software controlled datapath. Lab 2 revealed some shortcomings of our oscilloscope that this lab intends on correcting. Specifically, we will add:</p>
<ul class="simple">
<li><p>Using both trigger volt and trigger time for the trigger</p></li>
<li><p>Using polling and/or interrupts</p></li>
<li><p>The ability to enable and disable which channels are being displayed</p></li>
</ul>
<p>The following figure shows required functionality - your program should allow the user to change the position of the triggerVolt and triggerTime indicators with the result that the waveform should be drawn so that the periodic waveform is increasing through that voltage at that time.</p>
<p><img alt="Triggering" src="https://georgeyork.github.io/ECE383_web/lab/lab3/img/lab3-1.gif" /></p>
</section>
<section id="procedure">
<h2>💻 Procedure<a class="headerlink" href="#procedure" title="Permalink to this heading">#</a></h2>
<section id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h3>
<p>In order to accomplish this lab you will need to make some minor changes to the lab2 component, create a new custom IP, and then program that IP using the MicroBlaze, as described in the block diagram below. We will walk through these steps below.</p>
<p><img alt="Lab2_Hardware" src="https://georgeyork.github.io/ECE383_web/lab/lab3/img/lab3-2.jpg" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Remember the Ready signal in the diagram above is coming from the Flag Register (FlagQ). It is assumed that you hooked the Ready signal coming from the Audio Codec into the “Set Flag” input to the Flag Register and the output of the Flag register FlagQ is the new “Ready” signal coming out of the lab2_dp, and eventually connecting toe Microblaze’s interrupt pin. If you accidentally skip the Flag Register and hook the audio codec’s Ready signal directly to the interrupt pin, you will find your system plots the sinusoid’s incorrectly, plotting what looks to be a very high frequency sinusoid instead of the correct frequency.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If your Flag Register is 8-bits wide, you will need to extract the single bit of Q (the std_logic_vector output from the flag register) as the interrupt signal (the one set by the Ready signal). This may require you to extract the one bit Q as a separate signal to connect to the MicroBlaze in your block design.</p>
</div>
</section>
<section id="hardware">
<h3>Hardware<a class="headerlink" href="#hardware" title="Permalink to this heading">#</a></h3>
<p>Lab 3 will be setup similar to ICE 3.  You will create a new microblaze project, create a custom IP which contains all of your Lab 2 datapath and control unit (and everything inside it), recreate your clock wizard clocks, connect the ready flag register to the interrupt pin, and pass any data needed through the slave registers.  The ICE instructions will be helpful and the Lab 3 setup instructions from last year are <a class="reference external" href="https://georgeyork.github.io/ECE383_web/hand/Lab3_Install_short_version.pdf">here</a>, in case you want them.</p>
<p>For the most part, your hardware you developed in lab2 will be unchanged. For controlling your TriggerVolt and TriggerTime, you can either
(1) Retain your Lab2 buttons to control Trigger Volt and Trigger Time, but you must input these signals into Microblaze, and be able to display the values on the UART monitor
or
(2) Control TriggerVolt and TriggerTime from your Microblaze UART keyboard interface by using the slv_regs for microblaze to be able to write to TrigVolt and TrigTime into lab2 datapath ports</p>
</section>
<section id="hardware-setup">
<h3>Hardware Setup<a class="headerlink" href="#hardware-setup" title="Permalink to this heading">#</a></h3>
<p>Your first step will be to create a component for your lab2 component in your Vivado repository. This will require you to think about what signals are routed to the MicroBlaze and what signals are going outside the Artix 7 chip. The following table should help.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Signals To/From MicroBlaze</p></th>
<th class="head"><p>Signals Going Outside Artix 7</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>exWrAddr</p></td>
<td><p>clk</p></td>
</tr>
<tr class="row-odd"><td><p>exWen</p></td>
<td><p>reset</p></td>
</tr>
<tr class="row-even"><td><p>exSel</p></td>
<td><p>ac_mclk</p></td>
</tr>
<tr class="row-odd"><td><p>L_bus_out, R_bus_out</p></td>
<td><p>ac_adc_sdata</p></td>
</tr>
<tr class="row-even"><td><p>exLbus, exRbus</p></td>
<td><p>ac_dac_sdata</p></td>
</tr>
<tr class="row-odd"><td><p>flagQ</p></td>
<td><p>ac_bclk</p></td>
</tr>
<tr class="row-even"><td><p>flagClear</p></td>
<td><p>ac_lrclk</p></td>
</tr>
<tr class="row-odd"><td><p>triggerTime</p></td>
<td><p>sda</p></td>
</tr>
<tr class="row-even"><td><p>triggerVolt</p></td>
<td><p>scl</p></td>
</tr>
<tr class="row-odd"><td><p>ready</p></td>
<td><p>tmds</p></td>
</tr>
<tr class="row-even"><td><p>ch1_enb, ch2_enb?</p></td>
<td><p>tmdsb</p></td>
</tr>
</tbody>
</table>
<p>For the mapping of the MicroBlaze slv_reg to/from lab2 ports, you need to specify not only which 32-bit slv_reg for each signal, but also which bits are used, and whether it is read/write (in or out to microblaze). Hint: use this spreadsheet: <a class="reference external" href="https://georgeyork.github.io/ECE383_web/hand/lab3_signal_mapping.xlsx">lab3_signal_mapping.xlsx</a></p>
</section>
<section id="implementation-and-testing">
<h3>Implementation and Testing<a class="headerlink" href="#implementation-and-testing" title="Permalink to this heading">#</a></h3>
<p>Lessons from previous years:</p>
<ul class="simple">
<li><p>For all the lab2 signals you are reading into Microblaze AXI registers, add them to your C-code menu, using printf to print their values when you type the “?” command. This is very useful in debugging</p></li>
</ul>
<p>Build your C-code incrementally, with baby-step tests such as these (and add each of these tests as one of your C-code menu options):</p>
<ul class="simple">
<li><p>Draw a horizontal line on channel 1 and a diagonal line on channel 2, by writing the proper values to the BRAM (this test does not require your interface with the audio codec or the interrupt to work, and tests if you can write to the BRAM, and see the correct output on the scopeface)</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pseudo</span><span class="w"> </span><span class="n">code</span><span class="o">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">:</span><span class="w">     </span><span class="c1">// some of these will be XIL commands</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">			   </span><span class="n">exWrAddr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w"> </span><span class="c1">// set BRAM address</span>
<span class="w">			   </span><span class="n">exLBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">185</span><span class="p">;</span><span class="w"> </span><span class="c1">// row for horz line </span>
<span class="w">			                 </span><span class="c1">// need to shift to upper 10bits?</span>
<span class="w">			   </span><span class="n">exRBus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">   </span><span class="c1">// diagnonal line [need to shift?]</span>
<span class="w">			   </span><span class="n">exWen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">    </span><span class="c1">// write data to address in BRAM</span>
<span class="w">			   </span><span class="n">exWen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">    </span><span class="c1">// turn off write</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Or you could modify the above case ‘d’ to plot a sine wave, using a hardcoded sine wave look-up-table [this is only 64 samples so you would have to repeat it 16 times for 1024 samples]. Also, you need to scale these values to move to the upper 10-bits of the 16-bit values you write to the BRAM… like shift left 7, or multiply by 128.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">u16</span><span class="w"> </span><span class="n">sinFunc</span><span class="p">[</span><span class="mi">64</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">128</span><span class="p">,</span><span class="mi">141</span><span class="p">,</span><span class="mi">153</span><span class="p">,</span><span class="mi">165</span><span class="p">,</span><span class="mi">177</span><span class="p">,</span><span class="mi">189</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">210</span><span class="p">,</span><span class="mi">219</span><span class="p">,</span><span class="mi">227</span><span class="p">,</span><span class="mi">235</span><span class="p">,</span><span class="mi">241</span><span class="p">,</span><span class="mi">246</span><span class="p">,</span><span class="mi">250</span><span class="p">,</span><span class="mi">253</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span>
<span class="mi">255</span><span class="p">,</span><span class="mi">254</span><span class="p">,</span><span class="mi">252</span><span class="p">,</span><span class="mi">248</span><span class="p">,</span><span class="mi">244</span><span class="p">,</span><span class="mi">238</span><span class="p">,</span><span class="mi">231</span><span class="p">,</span><span class="mi">223</span><span class="p">,</span><span class="mi">214</span><span class="p">,</span><span class="mi">205</span><span class="p">,</span><span class="mi">194</span><span class="p">,</span><span class="mi">183</span><span class="p">,</span><span class="mi">171</span><span class="p">,</span><span class="mi">159</span><span class="p">,</span><span class="mi">147</span><span class="p">,</span><span class="mi">134</span><span class="p">,</span>
<span class="mi">122</span><span class="p">,</span><span class="mi">109</span><span class="p">,</span><span class="w"> </span><span class="mi">97</span><span class="p">,</span><span class="w"> </span><span class="mi">85</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">62</span><span class="p">,</span><span class="w"> </span><span class="mi">51</span><span class="p">,</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">18</span><span class="p">,</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">  </span><span class="mi">8</span><span class="p">,</span><span class="w">  </span><span class="mi">4</span><span class="p">,</span><span class="w">  </span><span class="mi">2</span><span class="p">,</span><span class="w">  </span><span class="mi">1</span><span class="p">,</span>
<span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="mi">3</span><span class="p">,</span><span class="w">  </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="w"> </span><span class="mi">29</span><span class="p">,</span><span class="w"> </span><span class="mi">37</span><span class="p">,</span><span class="w"> </span><span class="mi">46</span><span class="p">,</span><span class="w"> </span><span class="mi">56</span><span class="p">,</span><span class="w"> </span><span class="mi">67</span><span class="p">,</span><span class="w"> </span><span class="mi">79</span><span class="p">,</span><span class="w"> </span><span class="mi">91</span><span class="p">,</span><span class="mi">103</span><span class="p">,</span><span class="mi">115</span><span class="p">,</span><span class="mi">128</span><span class="p">};</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use polling (polling the ready flag) to grab each sample and write them into your C-array. (This is a good test to see if you are getting the ready flag, able to read live samples, able to clear the flag, and repeat to fill your array)</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pseudo</span><span class="w"> </span><span class="n">code</span><span class="o">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;m&#39;</span><span class="p">:</span><span class="w">     </span><span class="c1">// some of these will be XIL commands</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">while</span><span class="p">(</span><span class="n">flagQ</span><span class="o">==</span><span class="mi">0</span><span class="p">){};</span><span class="w"> </span><span class="c1">//wait on ready</span>
<span class="w">              </span><span class="n">array_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LbusReg</span><span class="p">;</span><span class="w"> </span><span class="c1">// read audio values</span>
<span class="w">              </span><span class="n">array_R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RbusReg</span><span class="p">;</span>
<span class="w">              </span><span class="n">ClearFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="c1">//clear the flag</span>
<span class="w">              </span><span class="n">ClearFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">//release the clear, so can be set again</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Use printf to print all the values in your array to the UART terminal (This is a good test to see if you are successfully reading audio codec samples in and storing them in your c arrary, or not)</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;p&#39;</span><span class="p">:</span><span class="w">     </span>
<span class="w">			</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">				</span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%x</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">array_L</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">			</span><span class="p">}</span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>case ‘w’: Write your 1024 C-array samples (not triggered) to the BRAM (This is a good test to use, after you fill the array in the test case ‘m’ above, to see if you can write it to the BRAM and see it appear on scopeface… and fix any calibration issues)</p></li>
<li><p>case ‘t’: Given trig_volt, trig_time, and Array_L, write a command to search through the C-array to find the trigger point, and printf this location to the terminal</p></li>
<li><p>case ‘z’: Given this trigger location in the Array_L, write the appropriate data values in the Array_L to the BRAM, so the sine wave appears triggerd.</p></li>
<li><p>case ‘g’: Now you have all the pieces to create the “continuous” mode using polling and triggering</p></li>
<li><p>case ‘i’: Use interrupts (ISR) to fill the Array_L and Array_R with samples (Then use case ‘t’ and case ‘z’ above to write the arrays to BRAM)</p></li>
<li><p>case ‘c’: Now you have all the pieces to create the “continuous” mode with interrupts</p></li>
<li><p>Note on the “continuous” mode with interrupts using a linear buffer: Remember Main() and ISR() communicate with each other through global variables.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="n">Main</span><span class="p">()</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">global</span><span class="w"> </span><span class="n">variable</span><span class="w"> </span><span class="n">ARRAY_FULL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="w"> </span>
<span class="w">  </span><span class="n">Whenever</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ISR</span><span class="p">()</span><span class="w"> </span><span class="n">wakes</span><span class="w"> </span><span class="n">up</span><span class="p">,</span><span class="w"> </span>
<span class="w">     </span><span class="n">It</span><span class="w"> </span><span class="n">clears</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span><span class="w">  </span>
<span class="w">     </span><span class="n">If</span><span class="w"> </span><span class="n">ARRAY_FULL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">then</span><span class="w"> </span>
<span class="w">	   </span><span class="n">the</span><span class="w"> </span><span class="n">ISR</span><span class="p">()</span><span class="w"> </span><span class="n">saves</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">array</span><span class="p">,</span><span class="w"> </span>
<span class="w">	   </span><span class="n">increments</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">next</span><span class="w"> </span><span class="n">set</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">samples</span><span class="p">,</span><span class="w"> </span>
<span class="w">	   </span><span class="n">and</span><span class="w"> </span><span class="n">eventually</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1023</span><span class="p">,</span><span class="w"> </span>
<span class="w">	      </span><span class="n">the</span><span class="w"> </span><span class="n">ISR</span><span class="p">()</span><span class="w"> </span><span class="n">sets</span><span class="w"> </span><span class="n">ARRAY_FULL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">and</span><span class="w"> </span>
<span class="w">		  </span><span class="n">resets</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pointer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">zero</span><span class="p">.</span><span class="w"> </span>
<span class="w">  </span><span class="n">Meanwhile</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="n">has</span><span class="w"> </span><span class="n">been</span><span class="w"> </span><span class="n">polling</span><span class="w"> </span><span class="n">ARRAY_FULL</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span>
<span class="w">     </span><span class="n">When</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="n">is</span><span class="p">,</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="n">calls</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">look</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">proper</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">array</span><span class="p">,</span><span class="w"> </span>
<span class="w">	 </span><span class="n">and</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">another</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">copy</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">correct</span><span class="w"> </span><span class="mi">620</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">BRAMs</span><span class="w"> </span><span class="n">based</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="n">location</span><span class="p">,</span>
<span class="w">	 </span><span class="n">And</span><span class="w"> </span><span class="n">then</span><span class="w"> </span><span class="n">main</span><span class="p">()</span><span class="w"> </span><span class="n">sets</span><span class="w"> </span><span class="n">ARRAY_FULL</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">	 </span><span class="n">and</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">ISR</span><span class="w"> </span><span class="n">starts</span><span class="w"> </span><span class="n">working</span><span class="w"> </span><span class="n">again</span><span class="p">...</span>
</pre></div>
</div>
<section id="lessons-learned-the-hard-way-in-previous-years">
<h4>Lessons Learned the Hard Way in Previous Years<a class="headerlink" href="#lessons-learned-the-hard-way-in-previous-years" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p>Depending on your design, you will want to control some signals (like TrigVolt, TrigTime, Ch1_enb, Ch2_enb) from the UART keyboard Terminal while your program is running in continuous mode. (You will not want to halt the program in order to change these settings, but rather change them “live”). Therefore, in your C code “while loop”, you may want to check if the user has hit the key on the keyboard without having to actually read the key. For these cases, the command XUartLite_IsReceiveEmpty() will prove useful. Note that “uartRegAddr” is a constant, the address of the uart.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">...</span>
<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">   </span><span class="c1">// run forever</span>
<span class="w">	</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">XUartLite_IsReceiveEmpty</span><span class="p">(</span><span class="n">uartRegAddr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    	</span><span class="n">c</span><span class="o">=</span><span class="n">XUartLite_RecvByte</span><span class="p">(</span><span class="n">uartRegAddr</span><span class="p">);</span>
<span class="w">		</span><span class="k">switch</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">		  </span><span class="p">...</span><span class="w">   </span><span class="c1">// handle case for key press</span>
<span class="w">		</span><span class="p">}</span><span class="w">  </span><span class="c1">// end switch</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="c1">// end if</span>
<span class="w">	</span><span class="n">If</span><span class="w"> </span><span class="p">(</span><span class="n">live_mode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">		</span><span class="n">Do</span><span class="w"> </span><span class="n">live</span><span class="w"> </span><span class="n">mode</span><span class="p">...</span><span class="w">  </span>
<span class="w">			</span><span class="n">grab</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">audio</span><span class="w"> </span><span class="n">codec</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">Array</span><span class="p">;</span>
<span class="w">			</span><span class="n">find</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">Array</span><span class="p">;</span>
<span class="w">			</span><span class="n">Write</span><span class="w"> </span><span class="mi">620</span><span class="w"> </span><span class="n">samples</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">Array</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">proper</span><span class="w"> </span><span class="n">location</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">BRAM</span><span class="p">;</span>
<span class="w">	</span><span class="p">}</span><span class="w"> </span><span class="c1">// end if</span>
<span class="p">}</span><span class="w"> </span><span class="c1">// end while</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Do NOT have polling FlagQ running at the same time as the ISR, as both would be attempting to clear the Flag, and you may find your system is missing samples, making the wave form plot appear to be a higher frequency than it actually is. One way to protect against this is to have all your polling cases disable interrupts with microblaze_disable_interrupts(), then microblaze_enable_interrupts() when you are done</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">pseudo</span><span class="w"> </span><span class="n">code</span><span class="o">:</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="sc">&#39;m&#39;</span><span class="p">:</span><span class="w">     </span><span class="c1">// some of these will be XIL commands</span>
<span class="w">		    </span><span class="n">microblaze_disable_interrupts</span><span class="p">();</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">1024</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="k">while</span><span class="p">(</span><span class="n">flagQ</span><span class="o">==</span><span class="mi">0</span><span class="p">){};</span><span class="w"> </span><span class="c1">//wait on ready</span>
<span class="w">              </span><span class="n">array_L</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LbusReg</span><span class="p">;</span><span class="w"> </span><span class="c1">// read audio values</span>
<span class="w">              </span><span class="n">array_R</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RbusReg</span><span class="p">;</span>
<span class="w">              </span><span class="n">ClearFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">   </span><span class="c1">//clear the flag</span>
<span class="w">              </span><span class="n">ClearFlag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">   </span><span class="c1">//release the clear, so can be set again</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">			</span><span class="n">microblaze_enable_interrupts</span><span class="p">();</span>
<span class="w">			</span><span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>When you are finding your trigger point in lab3, just like in lab2, you need to compare apples to apples. If your number in your C-array is 16-bits, it will be a large number in decimal like 26572, and this large 16-bit value you will want to write to your BRAM (as your VHDL code will later pull out the upper 10 or 9 bits) Meanwhile your triggerVolt is a small 10-bit number, like decimal 220. So to compare apples to apples in your C-code, (just for the purpose of finding the trigger) you might what to change the value in your C-array to the scale of the trigger volt by grabbing only its upper 10-bits (or in math, shift right 6 times, or divide by 2^6). Remember, in lab2 you probably also added (or subtracted?) an offset like the number like 34 (for the DC offset), so you would also need to add or subtract this from either trigvolt or the scale array number when you are doing the search for the trigger value.</p></li>
<li><p>Also, when doing your triggering math, make sure all your variables are declared as unsigned (like u16), not signed (like int), as the values are all unsigned and the comparisons will not work properly if declared as signed.</p></li>
<li><p>In the past, some students in their datapath hooked up L_Bus_out/R_Bus_Out directly to the 18-bit “signed” value coming out of the audio codec, not the 18-bit value converted to “unsigned”. If you do this, your sine wave will look strange (or maybe off the screen)… this can also impact your triggering. At some point, you need to convert from signed to unsigned. If you didn’t do this in your VHDL datapath, you could always do this in your C-code. If you are doing this conversion in C, remember you cannot just cast a variable from signed to unsigned. casting to unsigned in C would not do what you want (as we explained back in lab2). For example, if you have a signed value X = -7, and you cast X to an unsigned variable, what would -7 become? Unsigned values must be Zero or greater. -7 is undefined. If you go back to slide 11 in the lab2.pdf, you can see the pattern of this conversion with the 5 example numbers. It looks like all the lower bits stay the same, and only the MSB changes… it flips its value. I know two simple ways to flip the MSB (there are some other ways also), either (1) inverting the bit with a bitwise operator like XOR, or (2) adding a special number that keeps all the lower bits the same but only changes the MSB For method (2), adding the special number, look at the slide 11, you should be able to figure it out. For method (1), using XOR, ask yourself (a) what happens to a bit if I XOR it with ZERO?, and (b) what happens to a bit if I XOR it with ONE?</p></li>
<li><p>The XIL in and out functions are either 8-bit, 16-bit, or 32-bit [like Xil_Out16(exWraddr, i)], while you have some lab2 values that are different sizes (like trigvolt is 10-bits), so you may need to append bits in your VHDL code to make them match</p></li>
<li><p>Do not doing anything “slow” inside your ISR or while you are polling the samples into the array. Printf() is very slow. Also, writing your array_L values to the BRAM is very slow. So write your values from the Array_L to the BRAM in a different “for loop” than the route that grabs your samples from the audio codec into the Array_L.</p></li>
</ul>
</section>
</section>
</section>
<section id="deliverables">
<h2>🚚 Deliverables<a class="headerlink" href="#deliverables" title="Permalink to this heading">#</a></h2>
<section id="gate-check-1-design">
<h3>Gate Check 1 - Design<a class="headerlink" href="#gate-check-1-design" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><em>[5 Points]</em></p></li>
<li><p>You need to decide if TrigVolt, TrigTime, Ch1_enb, and Ch2_enb will be controlled via buttons on the FGPA board or using the UART keyboard controlling them through Microblaze.</p></li>
<li><p>For this Gate Check you will turn in a revised Lab2_datapath block diagram, correctly showing all these signals (and their directions), and adding or removing parts (like button debouncing).</p></li>
<li><p>Also for this Gate Check, you will turn in a mapping of 32 AXI registers (slv_reg) to lab2 signals. or the mapping of the MicroBlaze slv_reg to/from lab2 ports, you need to specify not only which 32-bit slv_reg for each signal, but also which bits are used, and whether it is read/write (in or out to microblaze). Hint: use this spreadsheet: <a class="reference external" href="https://georgeyork.github.io/ECE383_web/hand/lab3_signal_mapping.xlsx">lab3_signal_mapping.xlsx</a></p></li>
<li><p>Push your code to your GitHub repository using git with the <a class="reference external" href="https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag">tag</a> <code class="docutils literal notranslate"><span class="pre">Lab3_GC1</span></code></p></li>
</ul>
</section>
<section id="gate-check-2-lab-2-with-exsel-off-0">
<h3>Gate Check 2 - Lab 2 with ExSel Off (‘0’)<a class="headerlink" href="#gate-check-2-lab-2-with-exsel-off-0" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><em>[5 Points]</em></p></li>
<li><p>You need to have all of your Lab 2 functionality implemented with the Microblaze. That is, you need to be able to set ExSel to ‘0’ from your microblaze C program and be able to achieve the same functionality as you did in Lab 2.</p></li>
<li><p>The demo can be live to your instructor or a video uploaded to Teams.</p></li>
<li><p>Push your code to your GitHub repository using git with the <a class="reference external" href="https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag">tag</a> <code class="docutils literal notranslate"><span class="pre">Lab3_GC2</span></code></p></li>
</ul>
</section>
<section id="gate-check-3-cpu-interface">
<h3>Gate Check 3 - CPU Interface<a class="headerlink" href="#gate-check-3-cpu-interface" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><em>[5 Points]</em></p></li>
<li><p>You need to be able to send UART commands using the terminal to your FPGA to adjust the trigger on the screen. The trigger on the screen should properly react to moving the trigger either up or down. Or, if you choose to not to control the trigger from the terminal and kept the lab 2 Trigger Volt and Time buttons, then show on your UART display that your C program can read the Trigger Volt and Trigger Time from the hardware buttons.</p></li>
<li><p>You need to implement at least one of the baby-step tests mentioned above in the “Implementation and Testing” section.</p></li>
<li><p>The demo can be live to your instructor or a video uploaded to Teams.</p></li>
<li><p>Push your code to your GitHub repository using git with the <a class="reference external" href="https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag">tag</a> <code class="docutils literal notranslate"><span class="pre">Lab3_GC3</span></code></p></li>
</ul>
</section>
<section id="required-functionality">
<h3>Required Functionality<a class="headerlink" href="#required-functionality" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><em>[40 Points]</em></p></li>
</ul>
<p>In order to achieve required functionality, you will need to properly trigger the oscilloscope on channel 1 using a positive edge trigger. Control of this process is to be performed using the MicroBlaze. The main tasks of the MicroBlaze will include:</p>
<ul class="simple">
<li><p>Move audio samples into a pair of linear or circular buffers. These circular buffers will be maintained in the address space of the MicroBlaze. That is, you should have two big arrays defined in your program. Use interrupts or polling of the ready bit through the flag register.</p></li>
<li><p>Examine the samples, looking for a trigger event.</p></li>
<li><p>Fill the remaining sample slots in memory.</p></li>
<li><p>Move the appropriate buffer values into the display memory of the oscilloscope (lab2) component.</p></li>
<li><p>Provide a user menu (through the terminal) allowing the user to adjust the trigger voltage and trigger time. (Or if you did not implement trigger control in C show that your MicroBlaze can read trigger volt and time by displaying on the UART monitor)</p></li>
<li><p>Your system must operate in continuous mode (not blocked waiting on user key-press)</p></li>
<li><p>For partial credit if the full system is not working, enumerate the test cases that do work (like case ‘m’)</p></li>
<li><p>The demo can be live to your instructor or a video uploaded to Teams.</p></li>
<li><p>Push your code to your GitHub repository using git with the <a class="reference external" href="https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag">tag</a> <code class="docutils literal notranslate"><span class="pre">Lab3_ReqdFunc</span></code></p></li>
</ul>
</section>
<section id="a-level-functionality">
<h3>A-level Functionality<a class="headerlink" href="#a-level-functionality" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p><em>[10 Points]</em></p></li>
<li><p>Achieve required functionality.</p></li>
<li><p>Use the ready bit of the flag register to trigger an interrupt. The ISR should store the samples, look for a triggering event, and signal when the stored samples should be transfered to the BRAM in the oscilloscope component.</p></li>
<li><p>Add means to control Ch1_enb and Ch2_enb either by adding two FPGA board switches or controlled by MicroBlaze terminal interface.</p></li>
<li><p>The demo can be live to your instructor or a video uploaded to Teams.</p></li>
<li><p>Push your code to your GitHub repository using git with the <a class="reference external" href="https://www.atlassian.com/git/tutorials/inspecting-a-repository/git-tag">tag</a> <code class="docutils literal notranslate"><span class="pre">Lab3_AFunc</span></code></p></li>
</ul>
</section>
<section id="turn-in">
<h3>Turn In<a class="headerlink" href="#turn-in" title="Permalink to this heading">#</a></h3>
<ul class="simple">
<li><p>All of your work in this lab is to be submitted using Github and you will make submission in Gradescope to record the time each milestone is completed.</p></li>
</ul>
<section id="readme">
<h4>README<a class="headerlink" href="#readme" title="Permalink to this heading">#</a></h4>
<ul class="simple">
<li><p><em>[20 Points]</em>
For this lab, README only needs</p></li>
<li><p><strong>Design</strong>: Updated lab2 block diagram with correct signals</p></li>
<li><p><strong>Design</strong>: Mapping of 32 AXI registers to lab2 signals</p></li>
<li><p><strong>Functionality</strong></p>
<ul>
<li><p>Evidence of completing Gate Checks 1 and 2, required functionality, and A-functionality, along with the date/time achieved. This section should clearly state for each milestone/functionality the date/time it was achieved, level of achievement (e.g, achieved, partially-achieved, not achieved), what was achieved, and how you proved it (via demo or evidence like images/videos). For example, you could have a table like this:</p></li>
</ul>
</li>
</ul>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Milestone</p></th>
<th class="head"><p>Date/Time</p></th>
<th class="head"><p>What was achieved</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Gate Check 1</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Gate Check 2</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p>Gate Check 3</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-odd"><td><p>Required Functionality</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
<tr class="row-even"><td><p>A Functionality</p></td>
<td><p></p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p><strong>Conclusion</strong> - Explain what your learned from this lab and what changes you would recommend in future years to this lab or the lectures leading up to this lab.</p></li>
</ul>
</section>
</section>
<section id="grading">
<h3>Grading<a class="headerlink" href="#grading" title="Permalink to this heading">#</a></h3>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Item</p></th>
<th class="head"><p>Points</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Gate Check 1</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>Gate Check 2</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>Gate Check 3</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-odd"><td><p>Required Functionality</p></td>
<td><p>40</p></td>
</tr>
<tr class="row-even"><td><p>A-Level Functionality</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>Use of Git / GitHub</p></td>
<td><p>5</p></td>
</tr>
<tr class="row-even"><td><p>Code Style</p></td>
<td><p>10</p></td>
</tr>
<tr class="row-odd"><td><p>README</p></td>
<td><p>20</p></td>
</tr>
<tr class="row-even"><td><p><strong>Total</strong></p></td>
<td><p><strong>100</strong></p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./Assignments"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="lab2.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">🔬 Lab 2: Data Acquisition, Storage and Display</p>
      </div>
    </a>
    <a class="right-next"
       href="ice1.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">🔬 ICE 1: Intro to Microblaze</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#objectives">📌 Objectives</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#synopsis">📜 Synopsis</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#procedure">💻 Procedure</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware">Hardware</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#hardware-setup">Hardware Setup</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation-and-testing">Implementation and Testing</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#lessons-learned-the-hard-way-in-previous-years">Lessons Learned the Hard Way in Previous Years</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#deliverables">🚚 Deliverables</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-1-design">Gate Check 1 - Design</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-2-lab-2-with-exsel-off-0">Gate Check 2 - Lab 2 with ExSel Off (‘0’)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gate-check-3-cpu-interface">Gate Check 3 - CPU Interface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#required-functionality">Required Functionality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-level-functionality">A-level Functionality</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#turn-in">Turn In</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#readme">README</a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#grading">Grading</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By James Trimble
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2024.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>